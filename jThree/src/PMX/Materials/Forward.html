<?xml version="1.0" encoding="UTF-8"?>
<material name="jthree.gbuffer.pmx.forward" group="jthree.materials.forematerial" order="300">
<uniform-register>
  <register name="jthree.basic.matrix"/>
  <register name="jthree.basic.light"/>
</uniform-register>
<passes>
  <pass>
    <glsl>
      <![CDATA[
      attribute vec3 position;
      attribute vec3 normal;
      attribute vec2 uv;
      attribute vec4 boneWeights;
      attribute vec4 boneIndicies;
      varying vec3 vNormal;
      varying vec4 vPosition;
      varying vec2 vUV;
      varying vec2 vSphereUV;

      //@vertonly{
        //@import jthree.pmx.vertex
        uniform mat4 _matV;
        uniform mat4 _matPV;
        //@(register:2)
        uniform sampler2D boneMatriciesTexture;
        uniform float boneCount;

        void main(void){
          vUV = uv;
          mat4 boneTransform=calcBoneTransform(boneMatriciesTexture,boneCount,boneWeights,boneIndicies);
          vPosition=gl_Position = calcPosition(boneTransform,_matPV,position);
          vNormal = calcNormal(boneTransform,_matV,normal);
          vSphereUV = calcSphereUV(vNormal);
        }
      //}
      //@fragonly{
        uniform sampler2D _dlBuffer;
        uniform sampler2D _slBuffer;

        uniform vec4 diffuse;
        uniform vec4 specular;
        uniform vec3 ambient;
        //@(register:3)
        uniform sampler2D texture;
        //@(register:4)
        uniform sampler2D sphere;
        //@(register:5)
        uniform sampler2D toon;
        uniform int textureUsed;
        uniform int sphereMode;
        uniform int toonFlag;
        uniform vec4 addTexCoeff;
        uniform vec4 mulTexCoeff;
        uniform vec4 addSphereCoeff;
        uniform vec4 mulSphereCoeff;
        uniform vec4 addToonCoeff;
        uniform vec4 mulToonCoeff;
        uniform vec3 ambientCoefficient;

        vec2 calcLightUV(vec4 projectionSpacePos)
        {
           return (projectionSpacePos.xy/projectionSpacePos.w+vec2(1,1))/2.;
        }

        vec4 blendPMXTexture(sampler2D source,vec2 uv,vec4 addCoeff,vec4 mulCoeff)
        {
            vec4 result=texture2D(source,uv);
            result.rgb=mix(mix(result.rgb,vec3(0,0,0),addCoeff.a),vec3(1,1,1),1.-mulCoeff.a);
            result.rgb=result.rgb*mulCoeff.rgb+addCoeff.rgb;
            return result;
        }



        void main(void){
          //gl_FragColor = vec4(0,0,0,0);
          //vec2 lightUV=calcLightUV(vPosition);
          //vec3 dlc = texture2D(_dlBuffer,lightUV).rgb;
          //vec3 slc = texture2D(_slBuffer,lightUV).rgb;
          //vec3 alc = ambient * ambientCoefficient;
          //if(toonFlag==1)
          //{
        		//  float brightness = max(max(dlc.r,dlc.g),dlc.b);
          //    gl_FragColor.rgb+=blendPMXTexture(toon,vec2(0,1.-brightness),addToonCoeff ,mulToonCoeff ).rgb * dlc;
          //}else
          //{
          //    gl_FragColor.rgb+=dlc;
          //}
        	//gl_FragColor.a=diffuse.a;
          //gl_FragColor.rgb += slc + alc;
          gl_FragColor = vec4(1,0,0,1);
        }

      //}
      ]]>
    </glsl>
  </pass>
</passes>
</material>
