<?xml version="1.0" encoding="UTF-8"?>
  <material name="jthree.basic.distanceFog" group="jthree.materials.distanceFog" order="300">
    <uniform-register>
      <register name="jthree.basic.buffer" />
      <register name="jthree.basic.matrix" />
    </uniform-register>
    <passes>
      <pass>
        <depth enabled="false" />
        <glsl>
          <![CDATA[
        attribute vec3 position;
        varying vec4 vPosition;

        @vertonly{
          uniform mat4 _matV;

          void main(void)
          {
          	vPosition = vec4(position,1.0);
            gl_Position = vec4(position,1.0);
          }
        }

        @fragonly{
          //@import jthree.builtin.light.bufferreader

          //@(register:0,type:buffer,name:PRIMARY)
          uniform mediump sampler2D _buffer;
          //@(register:1,type:buffer,name:MAIN)
          uniform sampler2D _mainBuffer;
          uniform mat4 _matIP;

          void main()
          {
            vec4 rawBuffer = readRawBuffer(_buffer,vPosition);
            float depth = getDepth(rawBuffer);
            vec3 pos = getPosition(depth,vPosition,_matIP);
            vec2 uv = vPosition.xy/2. + vec2(0.5,0.5);
            float d = 1.0 + pos.z/20.;
          	gl_FragColor=texture2D(_mainBuffer,uv);
            gl_FragColor.rgb = mix(vec3(1,1,1),gl_FragColor.rgb,d);
              gl_FragColor.a = 1.0;
          }
        }

        ]]>
        </glsl>
      </pass>
    </passes>
  </material>
